<!-- Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->

<!DOCTYPE html>
<html>
<head>
    <title>Bedrock Model Usage Statistics</title>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-crosshair@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2, h3 { color: #333; }
        .quota-section { background-color: #fff8dc; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        .quota-section h4 { margin-top: 0; }
        .quota-section p { margin: 5px 0; }
        .merged-table { margin: 30px 0; }
        .merged-table table { border-collapse: collapse; width: 100%; }
        .merged-table th, .merged-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .merged-table th { background-color: #f2f2f2; font-weight: bold; }
        .merged-table .metric-cell { text-align: left; font-weight: bold; background-color: #f9f9f9; }
        .merged-table .stat-cell { text-align: left; padding-left: 30px; background-color: #fafafa; }
        .merged-table .inputtokencount-row { background-color: #f0f8ff; }
        .merged-table .outputtokencount-row { background-color: #fff5ee; }
        .merged-table .invocations-row { background-color: #f5f5dc; }
        .merged-table .invocationthrottles-row { background-color: #ffe8e8; }
        .merged-table .invocationclienterrors-row { background-color: #ffe4e1; }
        .merged-table .invocationservererrors-row { background-color: #ffcccb; }
        .merged-table .invocationlatency-row { background-color: #e6e6fa; }
        .merged-table .tpm-row { background-color: #e8f5e8; }
        .merged-table .rpm-row { background-color: #fff0e8; }
        .merged-table .tpd-row { background-color: #e8f0ff; }
        .contribution-table { margin: 10px 0; font-size: 0.85em; }
        .contribution-table table { border-collapse: collapse; width: 100%; }
        .contribution-table th, .contribution-table td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        .contribution-table th { background-color: #f2f2f2; font-weight: bold; }
        .contribution-table tr:hover { background-color: #f5f5f5; }
        .collapsible { cursor: pointer; padding: 15px; background-color: #f1f1f1; border: none; text-align: left; width: 100%; font-size: 1.1em; font-weight: bold; margin-top: 20px; border-radius: 5px; }
        .collapsible:hover { background-color: #e0e0e0; }
        .collapsible:after { content: ' ▼'; float: right; }
        .collapsible.active:after { content: ' ▲'; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .graphs-section { margin: 30px 0; }
        .period-row { display: flex; flex-direction: column; gap: 20px; margin-bottom: 20px; }
        .period-column { width: 100%; }
        .period-column.full-width { width: 100%; }
        .graph-container { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .graph-container canvas { max-height: 350px; }
        .na { background-color: #f0f0f0; color: #666; }
    </style>
</head>
<body>
    <h1>Bedrock Model Usage Statistics</h1>
    <h2>Model: {{ model_id }}</h2>
    <p><strong>Region:</strong> {{ region }}</p>
    <p><strong>Generated:</strong> {{ timestamp }}</p>
    
    {% if quotas.tpm or quotas.rpm or quotas.tpd or quotas.concurrent %}
    <div class="quota-section">
        <h4>Quota Limits</h4>
        {% if quotas.tpm %}
        <p><strong>TPM (Tokens Per Minute):</strong> {{ "{:,.0f}".format(quotas.tpm.value) }}<br>
        <span style="font-size: 0.85em;"><a href="{{ quotas.tpm.url }}" target="_blank">[{{ quotas.tpm.code }}]</a> {{ quotas.tpm.name }}</span></p>
        {% endif %}
        {% if quotas.rpm %}
        <p><strong>RPM (Requests Per Minute):</strong> {{ "{:,.0f}".format(quotas.rpm.value) }}<br>
        <span style="font-size: 0.85em;"><a href="{{ quotas.rpm.url }}" target="_blank">[{{ quotas.rpm.code }}]</a> {{ quotas.rpm.name }}</span></p>
        {% endif %}
        {% if quotas.tpd %}
        <p><strong>TPD (Tokens Per Day):</strong> {{ "{:,.0f}".format(quotas.tpd.value) }}<br>
        <span style="font-size: 0.85em;"><a href="{{ quotas.tpd.url }}" target="_blank">[{{ quotas.tpd.code }}]</a> {{ quotas.tpd.name }}</span></p>
        {% endif %}
        {% if quotas.concurrent %}
        <p><strong>Concurrent Requests:</strong> {{ "{:,.0f}".format(quotas.concurrent.value) }}<br>
        <span style="font-size: 0.85em;"><a href="{{ quotas.concurrent.url }}" target="_blank">[{{ quotas.concurrent.code }}]</a> {{ quotas.concurrent.name }}</span></p>
        {% endif %}
        <p><strong>IMPORTANT:</strong> These quotas (and those on the charts) were intelligently mapped with large language model. It is always good to crosscheck with <a href="https://console.aws.amazon.com/servicequotas">AWS service quotas</a></p>
    </div>
    {% endif %}
    
    <div class="merged-table">
        <h3>Statistics Summary</h3>
        <p style="font-style: italic; color: #666; margin-bottom: 10px;">Note: Numbers are rounded to the nearest integer</p>
        
        {# Table 1: Original Metrics #}
        <table>
            <tr>
                <th style="width: 230px;">Metric</th>
                <th style="width: 100px;">Statistic</th>
                {% for period in ['1hour', '1day', '7days', '14days', '30days'] %}
                <th>
                    {{ period.upper() }}<br>
                    <span style="font-size: 0.75em; font-style: italic; color: #888; font-weight: normal;">
                        {% set granularity_seconds = granularity_config.get(period, 300) %}
                        {% if granularity_seconds == 60 %}1-min data
                        {% elif granularity_seconds == 300 %}5-min data
                        {% elif granularity_seconds == 3600 %}1-hour data
                        {% else %}{{ granularity_seconds }}s data{% endif %}
                    </span>
                </th>
                {% endfor %}
            </tr>
            
            {% set metrics = ['InputTokenCount', 'OutputTokenCount', 'Invocations', 'InvocationThrottles', 'InvocationClientErrors', 'InvocationServerErrors', 'InvocationLatency'] %}
            {% set stats = ['P50', 'P90', 'Average', 'Total', 'Data Points'] %}
            {% set metrics_with_total = ['InputTokenCount', 'OutputTokenCount', 'Invocations', 'InvocationThrottles', 'InvocationClientErrors', 'InvocationServerErrors'] %}
            
            {% for metric in metrics %}
            {% set row_class = metric.lower().replace('_', '') + '-row' %}
            {% for stat in stats %}
            {% if not (stat == 'Total' and metric not in metrics_with_total) %}
            <tr class="{{ row_class }}">
                {% if loop.first %}
                <td class="metric-cell" rowspan="{{ 5 if metric in metrics_with_total else 4 }}">
                    {{ metric }}<br>
                    <span style="font-size: 0.75em; font-style: italic; color: #888; font-weight: normal;">
                        {% if metric == 'InvocationLatency' %}
                        aggregated with AVERAGE (milliseconds)
                        {% else %}
                        aggregated with SUM
                        {% endif %}
                    </span>
                </td>
                {% endif %}
                <td>{{ stat }}</td>
                {% for period in ['1hour', '1day', '7days', '14days', '30days'] %}
                {% set metric_data = time_periods[period]['__AGGREGATED__'].get(metric, {}) %}
                {% if stat == 'P50' %}
                <td style="text-align: right;">{{ "{:,}".format(metric_data.p50|round|int) if metric_data.p50 is defined else "0" }}</td>
                {% elif stat == 'P90' %}
                <td style="text-align: right;">{{ "{:,}".format(metric_data.p90|round|int) if metric_data.p90 is defined else "0" }}</td>
                {% elif stat == 'Average' %}
                <td style="text-align: right;">{{ "{:,}".format(metric_data.avg|round|int) if metric_data.avg is defined else "0" }}</td>
                {% elif stat == 'Total' %}
                <td style="text-align: right;">{{ "{:,}".format(metric_data.sum|round|int) if metric_data.sum is defined else "0" }}</td>
                {% elif stat == 'Data Points' %}
                <td style="text-align: right;">{{ metric_data.count if metric_data.count is defined else 0 }}</td>
                {% endif %}
                {% endfor %}
            </tr>
            {% endif %}
            {% endfor %}
            {% endfor %}
        </table>
        
        {# Table 2: Rate Metrics (TPM, RPM, TPD) - Always 1-min data #}
        <table style="margin-top: 0;">
            <tr>
                <th style="width: 230px;">Metric</th>
                <th style="width: 100px;">Statistic</th>
                {% for period in ['1hour', '1day', '7days', '14days', '30days'] %}
                <th>
                    {{ period.upper() }}<br>
                    <span style="font-size: 0.75em; font-style: italic; color: #888; font-weight: normal;">
                        1-min data
                    </span>
                </th>
                {% endfor %}
            </tr>
            
            {% set rate_metrics = ['TPM_1min', 'RPM_1min', 'TPD'] %}
            {% set rate_metric_labels = {'TPM_1min': 'TPM', 'RPM_1min': 'RPM', 'TPD': 'TPD'} %}
            {% set stats = ['P50', 'P90', 'Average', 'Data Points'] %}
            
            {% for metric in rate_metrics %}
            {% if metric != 'TPD' or period != '1hour' %}
            {% set row_class = metric.lower().replace('_', '') + '-row' %}
            {% for stat in stats %}
            <tr class="{{ row_class }}">
                {% if loop.first %}
                <td class="metric-cell" rowspan="4">
                    {{ rate_metric_labels[metric] }}<br>
                    <span style="font-size: 0.75em; font-style: italic; color: #888; font-weight: normal;">
                        {% if metric in ['TPM_1min', 'TPD'] %}
                        derived from token counts
                        {% elif metric == 'RPM_1min' %}
                        derived from invocations
                        {% endif %}
                    </span>
                </td>
                {% endif %}
                <td>{{ stat }}</td>
                {% for period in ['1hour', '1day', '7days', '14days', '30days'] %}
                {% if metric == 'TPD' and period == '1hour' %}
                <td style="text-align: right; color: #999;">N/A</td>
                {% else %}
                {% set metric_data = time_periods[period]['__AGGREGATED__'].get(metric, {}) %}
                {% if stat == 'P50' %}
                <td style="text-align: right;">{{ "{:,}".format(metric_data.p50|round|int) if metric_data.p50 is defined else "0" }}</td>
                {% elif stat == 'P90' %}
                <td style="text-align: right;">{{ "{:,}".format(metric_data.p90|round|int) if metric_data.p90 is defined else "0" }}</td>
                {% elif stat == 'Average' %}
                <td style="text-align: right;">{{ "{:,}".format(metric_data.avg|round|int) if metric_data.avg is defined else "0" }}</td>
                {% elif stat == 'Data Points' %}
                <td style="text-align: right;">{{ metric_data.count if metric_data.count is defined else 0 }}</td>
                {% endif %}
                {% endif %}
                {% endfor %}
            </tr>
            {% endfor %}
            {% endif %}
            {% endfor %}
        </table>
    </div>
    
    <div class="graphs-section">
        <h3>Time Series Graphs</h3>
        
        {# Row 1: 1hour and 1day side by side #}
        <div class="period-row">
            <div class="period-column">
                <button class="collapsible">{{ period_names.get("1hour", "Last 1 hour") }}</button>
                <div class="collapsible-content">
                
                    <div class="graph-container">
                        <h5>TPM (Tokens Per Minute)</h5>
                        {% if contributions.get('1hour') %}
                        <div class="contribution-table">
                            <table>
                                <tr>
                                    <th>Profile Name</th>
                                    <th>ID</th>
                                    <th>Tags</th>
                                    <th>P50</th>
                                    <th>P90</th>
                                    <th>Average</th>
                                </tr>
                                {% for contrib in contributions['1hour'] %}
                                <tr>
                                    <td>{{ contrib.profile_name }}</td>
                                    <td>{{ contrib.profile_arn_id }}</td>
                                    <td>{% if contrib.profile_tags %}{% for key, value in contrib.profile_tags.items() %}{{ key }}={{ value }}<br>{% endfor %}{% else %}N/A{% endif %}</td>
                                    <td>{{ "{:,.0f}".format(contrib.tpm_p50) }}</td>
                                    <td>{{ "{:,.0f}".format(contrib.tpm_p90) }}</td>
                                    <td>{{ "{:,.0f}".format(contrib.tpm_avg) }}</td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                        {% endif %}
                        <canvas id="tpm_1hour"></canvas>
                    </div>
                    
                    <div class="graph-container">
                        <h5>RPM (Requests Per Minute)</h5>
                        {% if contributions.get('1hour') %}
                        <div class="contribution-table">
                            <table>
                                <tr>
                                    <th>Profile Name</th>
                                    <th>ID</th>
                                    <th>Tags</th>
                                    <th>P50</th>
                                    <th>P90</th>
                                    <th>Average</th>
                                </tr>
                                {% for contrib in contributions['1hour'] %}
                                <tr>
                                    <td>{{ contrib.profile_name }}</td>
                                    <td>{{ contrib.profile_arn_id }}</td>
                                    <td>{% if contrib.profile_tags %}{% for key, value in contrib.profile_tags.items() %}{{ key }}={{ value }}<br>{% endfor %}{% else %}N/A{% endif %}</td>
                                    <td>{{ "{:,.0f}".format(contrib.rpm_p50) }}</td>
                                    <td>{{ "{:,.0f}".format(contrib.rpm_p90) }}</td>
                                    <td>{{ "{:,.0f}".format(contrib.rpm_avg) }}</td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                        {% endif %}
                        <canvas id="rpm_1hour"></canvas>
                    </div>
                    
                    <div class="graph-container">
                        <h5>Invocation Throttles</h5>
                        {% if contributions.get('1hour') %}
                        <div class="contribution-table">
                            <table>
                                <tr>
                                    <th>Profile Name</th>
                                    <th>ID</th>
                                    <th>Tags</th>
                                    <th>Total</th>
                                </tr>
                                {% for contrib in contributions['1hour'] %}
                                <tr>
                                    <td>{{ contrib.profile_name }}</td>
                                    <td>{{ contrib.profile_arn_id }}</td>
                                    <td>{% if contrib.profile_tags %}{% for key, value in contrib.profile_tags.items() %}{{ key }}={{ value }}<br>{% endfor %}{% else %}N/A{% endif %}</td>
                                    <td>{{ "{:,.0f}".format(contrib.throttles) }}</td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                        {% endif %}
                        <canvas id="throttles_1hour"></canvas>
                    </div>
                </div>
            </div>
            <div class="period-column">
                <button class="collapsible">{{ period_names.get("1day", "Last 1 day") }}</button>
                <div class="collapsible-content">
                    <div class="graph-container">
                        <h5>TPM (Tokens Per Minute)</h5>
                        {% if contributions.get('1day') %}
                        <div class="contribution-table">
                            <table>
                                <tr>
                                    <th>Profile Name</th>
                                    <th>ID</th>
                                    <th>Tags</th>
                                    <th>P50</th>
                                    <th>P90</th>
                                    <th>Average</th>
                                </tr>
                                {% for contrib in contributions['1day'] %}
                                <tr>
                                    <td>{{ contrib.profile_name }}</td>
                                    <td>{{ contrib.profile_arn_id }}</td>
                                    <td>{% if contrib.profile_tags %}{% for key, value in contrib.profile_tags.items() %}{{ key }}={{ value }}<br>{% endfor %}{% else %}N/A{% endif %}</td>
                                    <td>{{ "{:,.0f}".format(contrib.tpm_p50) }}</td>
                                    <td>{{ "{:,.0f}".format(contrib.tpm_p90) }}</td>
                                    <td>{{ "{:,.0f}".format(contrib.tpm_avg) }}</td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                        {% endif %}
                        <canvas id="tpm_1day"></canvas>
                    </div>
                    <div class="graph-container">
                        <h5>RPM (Requests Per Minute)</h5>
                        {% if contributions.get('1day') %}
                        <div class="contribution-table">
                            <table>
                                <tr>
                                    <th>Profile Name</th>
                                    <th>ID</th>
                                    <th>Tags</th>
                                    <th>P50</th>
                                    <th>P90</th>
                                    <th>Average</th>
                                </tr>
                                {% for contrib in contributions['1day'] %}
                                <tr>
                                    <td>{{ contrib.profile_name }}</td>
                                    <td>{{ contrib.profile_arn_id }}</td>
                                    <td>{% if contrib.profile_tags %}{% for key, value in contrib.profile_tags.items() %}{{ key }}={{ value }}<br>{% endfor %}{% else %}N/A{% endif %}</td>
                                    <td>{{ "{:,.0f}".format(contrib.rpm_p50) }}</td>
                                    <td>{{ "{:,.0f}".format(contrib.rpm_p90) }}</td>
                                    <td>{{ "{:,.0f}".format(contrib.rpm_avg) }}</td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                        {% endif %}
                        <canvas id="rpm_1day"></canvas>
                    </div>
                    <div class="graph-container">
                        <h5>TPD (Tokens Per Day)</h5>
                        {% if contributions.get('1day') %}
                        <div class="contribution-table">
                            <table>
                                <tr>
                                    <th>Profile Name</th>
                                    <th>ID</th>
                                    <th>Tags</th>
                                    <th>P50</th>
                                    <th>P90</th>
                                    <th>Average</th>
                                </tr>
                                {% for contrib in contributions['1day'] %}
                                <tr>
                                    <td>{{ contrib.profile_name }}</td>
                                    <td>{{ contrib.profile_arn_id }}</td>
                                    <td>{% if contrib.profile_tags %}{% for key, value in contrib.profile_tags.items() %}{{ key }}={{ value }}<br>{% endfor %}{% else %}N/A{% endif %}</td>
                                    <td>{{ "{:,.0f}".format(contrib.tpd_p50) }}</td>
                                    <td>{{ "{:,.0f}".format(contrib.tpd_p90) }}</td>
                                    <td>{{ "{:,.0f}".format(contrib.tpd_avg) }}</td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                        {% endif %}
                        <canvas id="tpd_1day"></canvas>
                    </div>
                    <div class="graph-container">
                        <h5>Invocation Throttles</h5>
                        {% if contributions.get('1day') %}
                        <div class="contribution-table">
                            <table>
                                <tr>
                                    <th>Profile Name</th>
                                    <th>ID</th>
                                    <th>Tags</th>
                                    <th>Total</th>
                                </tr>
                                {% for contrib in contributions['1day'] %}
                                <tr>
                                    <td>{{ contrib.profile_name }}</td>
                                    <td>{{ contrib.profile_arn_id }}</td>
                                    <td>{% if contrib.profile_tags %}{% for key, value in contrib.profile_tags.items() %}{{ key }}={{ value }}<br>{% endfor %}{% else %}N/A{% endif %}</td>
                                    <td>{{ "{:,.0f}".format(contrib.throttles) }}</td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                        {% endif %}
                        <canvas id="throttles_1day"></canvas>
                    </div>
                </div>
            </div>
            <div class="period-column">
                <button class="collapsible">{{ period_names.get("7days", "Last 7 days") }}</button>
                <div class="collapsible-content">       
                    <div class="graph-container">
                        <h5>TPM (Tokens Per Minute)</h5>
                        {% if contributions.get('7days') %}
                        <div class="contribution-table">
                            <table>
                                <tr><th>Profile Name</th><th>ID</th><th>Tags</th><th>P50</th><th>P90</th><th>Average</th></tr>
                                {% for contrib in contributions['7days'] %}
                                <tr>
                                    <td>{{ contrib.profile_name }}</td>
                                    <td>{{ contrib.profile_arn_id }}</td>
                                    <td>{% if contrib.profile_tags %}{% for key, value in contrib.profile_tags.items() %}{{ key }}={{ value }}<br>{% endfor %}{% else %}N/A{% endif %}</td>
                                    <td>{{ "{:,.0f}".format(contrib.tpm_p50) }}</td>
                                    <td>{{ "{:,.0f}".format(contrib.tpm_p90) }}</td>
                                    <td>{{ "{:,.0f}".format(contrib.tpm_avg) }}</td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                        {% endif %}
                        <canvas id="tpm_7days"></canvas>
                    </div>
                    <div class="graph-container">
                        <h5>RPM (Requests Per Minute)</h5>
                        {% if contributions.get('7days') %}
                        <div class="contribution-table">
                            <table>
                                <tr><th>Profile Name</th><th>ID</th><th>Tags</th><th>P50</th><th>P90</th><th>Average</th></tr>
                                {% for contrib in contributions['7days'] %}
                                <tr>
                                    <td>{{ contrib.profile_name }}</td>
                                    <td>{{ contrib.profile_arn_id }}</td>
                                    <td>{% if contrib.profile_tags %}{% for key, value in contrib.profile_tags.items() %}{{ key }}={{ value }}<br>{% endfor %}{% else %}N/A{% endif %}</td>
                                    <td>{{ "{:,.0f}".format(contrib.rpm_p50) }}</td>
                                    <td>{{ "{:,.0f}".format(contrib.rpm_p90) }}</td>
                                    <td>{{ "{:,.0f}".format(contrib.rpm_avg) }}</td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                        {% endif %}
                        <canvas id="rpm_7days"></canvas>
                    </div>
                    <div class="graph-container">
                        <h5>TPD (Tokens Per Day)</h5>
                        {% if contributions.get('7days') %}
                        <div class="contribution-table">
                            <table>
                                <tr><th>Profile Name</th><th>ID</th><th>Tags</th><th>P50</th><th>P90</th><th>Average</th></tr>
                                {% for contrib in contributions['7days'] %}
                                <tr>
                                    <td>{{ contrib.profile_name }}</td>
                                    <td>{{ contrib.profile_arn_id }}</td>
                                    <td>{% if contrib.profile_tags %}{% for key, value in contrib.profile_tags.items() %}{{ key }}={{ value }}<br>{% endfor %}{% else %}N/A{% endif %}</td>
                                    <td>{{ "{:,.0f}".format(contrib.tpd_p50) }}</td>
                                    <td>{{ "{:,.0f}".format(contrib.tpd_p90) }}</td>
                                    <td>{{ "{:,.0f}".format(contrib.tpd_avg) }}</td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                        {% endif %}
                        <canvas id="tpd_7days"></canvas>
                    </div>
                    <div class="graph-container">
                        <h5>Invocation Throttles</h5>
                        {% if contributions.get('7days') %}
                        <div class="contribution-table">
                            <table>
                                <tr><th>Profile Name</th><th>ID</th><th>Tags</th><th>Total</th></tr>
                                {% for contrib in contributions['7days'] %}
                                <tr>
                                    <td>{{ contrib.profile_name }}</td>
                                    <td>{{ contrib.profile_arn_id }}</td>
                                    <td>{% if contrib.profile_tags %}{% for key, value in contrib.profile_tags.items() %}{{ key }}={{ value }}<br>{% endfor %}{% else %}N/A{% endif %}</td>
                                    <td>{{ "{:,.0f}".format(contrib.throttles) }}</td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                        {% endif %}
                        <canvas id="throttles_7days"></canvas>
                    </div>
                </div>
            </div>
            <div class="period-column">
                <button class="collapsible">{{ period_names.get("14days", "Last 14 days") }}</button>
                <div class="collapsible-content">
                    <div class="graph-container">
                        <h5>TPM (Tokens Per Minute)</h5>
                        {% if contributions.get('14days') %}
                        <div class="contribution-table">
                            <table>
                                <tr><th>Profile Name</th><th>ID</th><th>Tags</th><th>P50</th><th>P90</th><th>Average</th></tr>
                                {% for contrib in contributions['14days'] %}
                                <tr>
                                    <td>{{ contrib.profile_name }}</td>
                                    <td>{{ contrib.profile_arn_id }}</td>
                                    <td>{% if contrib.profile_tags %}{% for key, value in contrib.profile_tags.items() %}{{ key }}={{ value }}<br>{% endfor %}{% else %}N/A{% endif %}</td>
                                    <td>{{ "{:,.0f}".format(contrib.tpm_p50) }}</td>
                                    <td>{{ "{:,.0f}".format(contrib.tpm_p90) }}</td>
                                    <td>{{ "{:,.0f}".format(contrib.tpm_avg) }}</td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                        {% endif %}
                        <canvas id="tpm_14days"></canvas>
                    </div>
                    <div class="graph-container">
                        <h5>RPM (Requests Per Minute)</h5>
                        {% if contributions.get('14days') %}
                        <div class="contribution-table">
                            <table>
                                <tr><th>Profile Name</th><th>ID</th><th>Tags</th><th>P50</th><th>P90</th><th>Average</th></tr>
                                {% for contrib in contributions['14days'] %}
                                <tr>
                                    <td>{{ contrib.profile_name }}</td>
                                    <td>{{ contrib.profile_arn_id }}</td>
                                    <td>{% if contrib.profile_tags %}{% for key, value in contrib.profile_tags.items() %}{{ key }}={{ value }}<br>{% endfor %}{% else %}N/A{% endif %}</td>
                                    <td>{{ "{:,.0f}".format(contrib.rpm_p50) }}</td>
                                    <td>{{ "{:,.0f}".format(contrib.rpm_p90) }}</td>
                                    <td>{{ "{:,.0f}".format(contrib.rpm_avg) }}</td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                        {% endif %}
                        <canvas id="rpm_14days"></canvas>
                    </div>
                    <div class="graph-container">
                        <h5>TPD (Tokens Per Day)</h5>
                        {% if contributions.get('14days') %}
                        <div class="contribution-table">
                            <table>
                                <tr><th>Profile Name</th><th>ID</th><th>Tags</th><th>P50</th><th>P90</th><th>Average</th></tr>
                                {% for contrib in contributions['14days'] %}
                                <tr>
                                    <td>{{ contrib.profile_name }}</td>
                                    <td>{{ contrib.profile_arn_id }}</td>
                                    <td>{% if contrib.profile_tags %}{% for key, value in contrib.profile_tags.items() %}{{ key }}={{ value }}<br>{% endfor %}{% else %}N/A{% endif %}</td>
                                    <td>{{ "{:,.0f}".format(contrib.tpd_p50) }}</td>
                                    <td>{{ "{:,.0f}".format(contrib.tpd_p90) }}</td>
                                    <td>{{ "{:,.0f}".format(contrib.tpd_avg) }}</td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                        {% endif %}
                        <canvas id="tpd_14days"></canvas>
                    </div>
                    <div class="graph-container">
                        <h5>Invocation Throttles</h5>
                        {% if contributions.get('14days') %}
                        <div class="contribution-table">
                            <table>
                                <tr><th>Profile Name</th><th>ID</th><th>Tags</th><th>Total</th></tr>
                                {% for contrib in contributions['14days'] %}
                                <tr>
                                    <td>{{ contrib.profile_name }}</td>
                                    <td>{{ contrib.profile_arn_id }}</td>
                                    <td>{% if contrib.profile_tags %}{% for key, value in contrib.profile_tags.items() %}{{ key }}={{ value }}<br>{% endfor %}{% else %}N/A{% endif %}</td>
                                    <td>{{ "{:,.0f}".format(contrib.throttles) }}</td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                        {% endif %}
                        <canvas id="throttles_14days"></canvas>
                    </div>
                </div>                  
             </div>
        </div>
        <div class="period-column">
            <button class="collapsible">{{ period_names.get("30days", "Last 30 days") }}</button>
            <div class="collapsible-content">
                <div class="graph-container">
                    <h5>TPM (Tokens Per Minute)</h5>
                    {% if contributions.get('30days') %}
                    <div class="contribution-table">
                        <table>
                            <tr><th>Profile Name</th><th>ID</th><th>Tags</th><th>P50</th><th>P90</th><th>Average</th></tr>
                            {% for contrib in contributions['30days'] %}
                            <tr>
                                <td>{{ contrib.profile_name }}</td>
                                <td>{{ contrib.profile_arn_id }}</td>
                                <td>{% if contrib.profile_tags %}{% for key, value in contrib.profile_tags.items() %}{{ key }}={{ value }}<br>{% endfor %}{% else %}N/A{% endif %}</td>
                                <td>{{ "{:,.0f}".format(contrib.tpm_p50) }}</td>
                                <td>{{ "{:,.0f}".format(contrib.tpm_p90) }}</td>
                                <td>{{ "{:,.0f}".format(contrib.tpm_avg) }}</td>
                            </tr>
                            {% endfor %}
                        </table>
                    </div>
                    {% endif %}
                    <canvas id="tpm_30days"></canvas>
                </div>
                <div class="graph-container">
                    <h5>RPM (Requests Per Minute)</h5>
                    {% if contributions.get('30days') %}
                    <div class="contribution-table">
                        <table>
                            <tr><th>Profile Name</th><th>ID</th><th>Tags</th><th>P50</th><th>P90</th><th>Average</th></tr>
                            {% for contrib in contributions['30days'] %}
                            <tr>
                                <td>{{ contrib.profile_name }}</td>
                                <td>{{ contrib.profile_arn_id }}</td>
                                <td>{% if contrib.profile_tags %}{% for key, value in contrib.profile_tags.items() %}{{ key }}={{ value }}<br>{% endfor %}{% else %}N/A{% endif %}</td>
                                <td>{{ "{:,.0f}".format(contrib.rpm_p50) }}</td>
                                <td>{{ "{:,.0f}".format(contrib.rpm_p90) }}</td>
                                <td>{{ "{:,.0f}".format(contrib.rpm_avg) }}</td>
                            </tr>
                            {% endfor %}
                        </table>
                    </div>
                    {% endif %}
                    <canvas id="rpm_30days"></canvas>
                </div>
                <div class="graph-container">
                    <h5>TPD (Tokens Per Day)</h5>
                    {% if contributions.get('30days') %}
                    <div class="contribution-table">
                        <table>
                            <tr><th>Profile Name</th><th>ID</th><th>Tags</th><th>P50</th><th>P90</th><th>Average</th></tr>
                            {% for contrib in contributions['30days'] %}
                            <tr>
                                <td>{{ contrib.profile_name }}</td>
                                <td>{{ contrib.profile_arn_id }}</td>
                                <td>{% if contrib.profile_tags %}{% for key, value in contrib.profile_tags.items() %}{{ key }}={{ value }}<br>{% endfor %}{% else %}N/A{% endif %}</td>
                                <td>{{ "{:,.0f}".format(contrib.tpd_p50) }}</td>
                                <td>{{ "{:,.0f}".format(contrib.tpd_p90) }}</td>
                                <td>{{ "{:,.0f}".format(contrib.tpd_avg) }}</td>
                            </tr>
                            {% endfor %}
                        </table>
                    </div>
                    {% endif %}
                    <canvas id="tpd_30days"></canvas>
                </div>
                <div class="graph-container">
                    <h5>Invocation Throttles</h5>
                    {% if contributions.get('30days') %}
                    <div class="contribution-table">
                        <table>
                            <tr><th>Profile Name</th><th>ID</th><th>Tags</th><th>Total</th></tr>
                            {% for contrib in contributions['30days'] %}
                            <tr>
                                <td>{{ contrib.profile_name }}</td>
                                <td>{{ contrib.profile_arn_id }}</td>
                                <td>{% if contrib.profile_tags %}{% for key, value in contrib.profile_tags.items() %}{{ key }}={{ value }}<br>{% endfor %}{% else %}N/A{% endif %}</td>
                                <td>{{ "{:,.0f}".format(contrib.throttles) }}</td>
                            </tr>
                            {% endfor %}
                        </table>
                    </div>
                    {% endif %}
                    <canvas id="throttles_30days"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const chartConfig = {
            type: 'line',
            options: {
                responsive: true,
                interaction: { mode: 'nearest', intersect: false, axis: 'x' },
                plugins: { 
                    tooltip: { 
                        mode: 'nearest', 
                        intersect: false, 
                        axis: 'x',
                        filter: function(tooltipItem) {
                            // Exclude quota line from tooltip
                            return tooltipItem.dataset.label !== 'Quota Limit';
                        }
                    },
                    crosshair: { line: { color: '#999', width: 1, dashPattern: [5, 5] }, sync: { enabled: true } }
                },
                scales: {
                    x: { 
                        type: 'time',
                        time: {
                            displayFormats: {
                                hour: 'HH:mm',
                                day: 'MMM dd HH:mm'
                            },
                            tooltipFormat: 'MMM dd, yyyy HH:mm'
                        },
                        ticks: {
                            source: 'auto',
                            autoSkip: true,
                            maxTicksLimit: 12,
                            callback: function(value, index, ticks) {
                                const date = new Date(value);
                                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                                
                                // Show date on first tick
                                if (index === 0) {
                                    return dateStr + ' ' + timeStr;
                                }
                                
                                // Check if any previous tick has the same date
                                let sameDate = false;
                                for (let i = 0; i < index; i++) {
                                    const prevDate = new Date(ticks[i].value);
                                    const prevDateStr = prevDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                    if (prevDateStr === dateStr) {
                                        sameDate = true;
                                        break;
                                    }
                                }
                                
                                // Show date if this is the first tick with this date
                                if (!sameDate) {
                                    return dateStr + ' ' + timeStr;
                                }
                                
                                // Otherwise just show time
                                return timeStr;
                            }
                        },
                        display: true, 
                        title: { display: true, text: 'Time' } 
                    },
                    y: { display: true, title: { display: true, text: 'Value' } }
                }
            }
        };

        const timeSeriesData = {{ time_series_json | safe }};
        const quotas = {{ quotas_json | safe }};
        const profileNames = {{ profile_names_json | safe }};
        const colors = ['#4285F4', '#EA4335', '#FBBC04', '#34A853', '#FF6D00', '#46BDC6', '#7BAAF7', '#F07B72', '#FDD663', '#81C995'];
        
        // Create consistent color mapping for all profiles across all charts
        const profileColorMap = {};
        let nextColorIndex = 0;
        {% for time_period in time_periods.keys() %}
        for (const [modelId, data] of Object.entries(timeSeriesData['{{ time_period }}'] || {})) {
            if (modelId !== '__AGGREGATED__' && !profileColorMap[modelId]) {
                profileColorMap[modelId] = colors[nextColorIndex % colors.length];
                nextColorIndex++;
            }
        }
        {% endfor %}
        
        // Store chart instances by period for synchronization
        const chartsByPeriod = {
            '1hour': [],
            '1day': [],
            '7days': [],
            '14days': [],
            '30days': []
        };
        
        {% for time_period in time_periods.keys() %}
        
        ['TPM', 'RPM', 'TPD', 'InvocationThrottles'].forEach(metricType => {
            if (metricType === 'TPD' && '{{ time_period }}' === '1hour') return;
            
            const chartData = { datasets: [] };
            let aggregatedData = null;
            
            for (const [modelId, data] of Object.entries(timeSeriesData['{{ time_period }}'] || {})) {
                if (data[metricType] && data[metricType].timestamps.length > 0) {
                    if (modelId === '__AGGREGATED__') {
                        aggregatedData = {
                            label: 'Total (Aggregated)',
                            data: data[metricType].timestamps.map((ts, i) => ({ x: ts, y: data[metricType].values[i] })),
                            borderColor: '#FF8C00',
                            backgroundColor: '#FF8C0020',
                            borderWidth: 1.2,
                            pointRadius: 0.5,
                            tension: 0.1,
                            spanGaps: false
                        };
                    } else {
                        const profileName = profileNames[modelId] || modelId;
                        const profileColor = profileColorMap[modelId];
                        chartData.datasets.push({
                            label: profileName,
                            data: data[metricType].timestamps.map((ts, i) => ({ x: ts, y: data[metricType].values[i] })),
                            borderColor: profileColor,
                            backgroundColor: profileColor + '20',
                            borderWidth: 0.8,
                            pointRadius: 0.5,
                            tension: 0.1,
                            spanGaps: false
                        });
                    }
                }
            }
            
            // Add aggregated line first (so it appears on top in legend)
            if (aggregatedData) {
                chartData.datasets.unshift(aggregatedData);
            }
            
            // Add quota line if available
            let quotaValue = null;
            let quotaInfo = null;
            if (metricType === 'TPM' && quotas.tpm) {
                quotaValue = quotas.tpm.value;
                quotaInfo = quotas.tpm;
            } else if (metricType === 'RPM' && quotas.rpm) {
                quotaValue = quotas.rpm.value;
                quotaInfo = quotas.rpm;
            } else if (metricType === 'TPD' && quotas.tpd) {
                quotaValue = quotas.tpd.value;
                quotaInfo = quotas.tpd;
            }
            
            const canvasId = metricType === 'InvocationThrottles' ? 'throttles_{{ time_period }}' : 
                            metricType.toLowerCase() + '_{{ time_period }}';
            
            const canvasElement = document.getElementById(canvasId);
            if (!canvasElement) {
                console.error(`Canvas element not found: ${canvasId}`);
                return;
            }
            
            // Add disclaimer above chart if quota exists
            if (quotaInfo) {
                const existingDisclaimer = canvasElement.previousElementSibling;
                if (!existingDisclaimer || !existingDisclaimer.classList.contains('quota-disclaimer')) {
                    const disclaimer = document.createElement('p');
                    disclaimer.className = 'quota-disclaimer';
                    disclaimer.style.fontSize = '0.85em';
                    disclaimer.style.fontStyle = 'italic';
                    disclaimer.style.color = '#666';
                    disclaimer.style.marginBottom = '10px';
                    disclaimer.innerHTML = `Note: Quota mapping inferred using AI. Verify with <a href="${quotaInfo.url}" target="_blank">[${quotaInfo.code}] ${quotaInfo.name}</a>`;
                    canvasElement.parentNode.insertBefore(disclaimer, canvasElement);
                }
            }
            
            // Add note about peak values for TPM/RPM when granularity > 1 minute
            const granularityConfig = {{ granularity_config | tojson }};
            const currentGranularity = granularityConfig['{{ time_period }}'] || 60;
            if ((metricType === 'TPM' || metricType === 'RPM') && currentGranularity > 60) {
                const existingNote = canvasElement.previousElementSibling;
                if (!existingNote || !existingNote.classList.contains('peak-note')) {
                    const note = document.createElement('p');
                    note.className = 'peak-note';
                    note.style.fontSize = '0.8em';
                    note.style.fontStyle = 'italic';
                    note.style.color = '#888';
                    note.style.marginBottom = '5px';
                    note.innerHTML = `Note: Values show peak ${metricType} within each aggregation period (for quota monitoring)`;
                    canvasElement.parentNode.insertBefore(note, canvasElement);
                }
            }
            
            // Skip chart creation if there's no data
            if (chartData.datasets.length === 0) {
                console.log(`No data for ${metricType} in {{ time_period }}, skipping chart`);
                return;
            }
            
            // Create chart with crosshair sync enabled for this period
            try {
                // Create unique tick callback with closure for this chart
                const createTickCallback = () => {
                    const timePeriod = '{{ time_period }}';
                    const isLongPeriod = ['7days', '14days', '30days'].includes(timePeriod);
                    
                    return function(value, index, ticks) {
                        const date = new Date(value);
                        const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                        
                        if (isLongPeriod) {
                            // For 7/14/30 days: show date on every tick (two lines)
                            return dateStr + '\n' + timeStr;
                        } else {
                            // For 1hour/1day: show date only at first, midnight, and last tick
                            const isFirst = index === 0;
                            const isLast = index === ticks.length - 1;
                            const isMidnight = date.getHours() === 0 && date.getMinutes() === 0;
                            
                            if (isFirst || isLast || isMidnight) {
                                return dateStr + ' ' + timeStr;
                            }
                            return timeStr;
                        }
                    };
                };
                
                // Calculate X-axis boundaries based on time period and actual end time
                const periodDurations = {
                    '1hour': 60 * 60 * 1000,
                    '1day': 24 * 60 * 60 * 1000,
                    '7days': 7 * 24 * 60 * 60 * 1000,
                    '14days': 14 * 24 * 60 * 60 * 1000,
                    '30days': 30 * 24 * 60 * 60 * 1000
                };
                const timePeriod = '{{ time_period }}';
                const duration = periodDurations[timePeriod];
                const endTimeIso = '{{ end_time_iso }}';
                
                var xAxisMax = new Date(endTimeIso).getTime();
                var xAxisMin = xAxisMax - duration;
                
                // Add quota line using chart boundaries
                if (quotaValue && xAxisMin && xAxisMax) {
                    chartData.datasets.push({
                        label: 'Quota Limit',
                        data: [
                            { x: new Date(xAxisMin).toISOString(), y: quotaValue },
                            { x: new Date(xAxisMax).toISOString(), y: quotaValue }
                        ],
                        borderColor: 'red',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false,
                        tension: 0
                    });
                }
                
                const chartInstance = new Chart(canvasElement, { 
                    ...chartConfig, 
                    data: chartData,
                    options: {
                        ...chartConfig.options,
                        scales: {
                            ...chartConfig.options.scales,
                            x: {
                                ...chartConfig.options.scales.x,
                                min: xAxisMin,
                                max: xAxisMax,
                                ticks: {
                                    ...chartConfig.options.scales.x.ticks,
                                    callback: createTickCallback(),
                                    maxRotation: 45,
                                    minRotation: 0,
                                    autoSkip: true
                                }
                            }
                        },
                        plugins: {
                            ...chartConfig.options.plugins,
                            crosshair: {
                                line: { color: '#999', width: 1, dashPattern: [5, 5] },
                                sync: { enabled: true, group: '{{ time_period }}' },
                                zoom: { enabled: false }
                            }
                        }
                    }
                });
                
                chartsByPeriod['{{ time_period }}'].push(chartInstance);
            } catch (error) {
                console.error(`Error creating chart ${canvasId}:`, error);
            }
        });
        
        {% endfor %}
    </script>
    
    <script>
        // Collapsible sections functionality
        var coll = document.getElementsByClassName("collapsible");
        for (var i = 0; i < coll.length; i++) {
            coll[i].addEventListener("click", function() {
                this.classList.toggle("active");
                var content = this.nextElementSibling;
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
            });
        }
    </script>
</body>
</html>
